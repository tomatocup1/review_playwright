{% extends "base.html" %}

{% block title %}ë¦¬ë·° ê´€ë¦¬ - {{ super() }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/reviews.css') }}">
<style>
    /* ë¦¬ë·° í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1rem;
    }
    
    .stats-card h3 {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .filter-section {
        background-color: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .review-card {
        background-color: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }
    
    .review-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .rating-stars {
        color: #f59e0b;
    }
    
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .status-pending {
        background-color: #fef3c7;
        color: #92400e;
    }
    
    .status-posted {
        background-color: #d1fae5;
        color: #065f46;
    }
    
    .status-failed {
        background-color: #fee2e2;
        color: #991b1b;
    }
    
    .status-generated {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    
    .status-ready_to_post {
        background-color: #cce5ff;
        color: #004085;
    }
    
    .platform-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .platform-baemin {
        background-color: #00d4d4;
        color: white;
    }
    
    .platform-yogiyo {
        background-color: #fa0050;
        color: white;
    }
    
    .platform-coupang {
        background-color: #5a2e0e;
        color: white;
    }
    
    .ai-controls {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }
    
    .btn-ai {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-ai:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }
    
    .btn-regenerate {
        background: linear-gradient(135deg, #ffc107, #ff8c00);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-regenerate:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
    }
    
    .ai-reply-section {
        background: #f0f8ff;
        border: 1px solid #bee5eb;
        border-radius: 6px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .ai-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        background: #e3f2fd;
        border-radius: 4px;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }
    
    .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .login-prompt {
        text-align: center;
        padding: 3rem;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .login-prompt i {
        font-size: 4rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
    }
    
    .debug-info {
        background-color: #f0f0f0;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- ë””ë²„ê·¸ ì •ë³´ -->
    <div id="debugInfo" class="debug-info" style="display: none;">
        <h5>ë””ë²„ê·¸ ì •ë³´</h5>
        <div id="debugContent"></div>
    </div>
    
    <!-- ë¡œê·¸ì¸ ì²´í¬ -->
    <div id="loginPrompt" class="login-prompt" style="display: none;">
        <i class="bi bi-lock"></i>
        <h2>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
        <p class="text-muted mb-3">ë¦¬ë·° ê´€ë¦¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
        <a href="/login" class="btn btn-primary">ë¡œê·¸ì¸í•˜ê¸°</a>
    </div>
    
    <!-- ë©”ì¸ ì»¨í…ì¸  (ë¡œê·¸ì¸ í›„ í‘œì‹œ) -->
    <div id="mainContent" style="display: block;">
        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="mb-4">
            <h1 class="mb-2">ğŸ¤– AI ë¦¬ë·° ê´€ë¦¬</h1>
            <p class="text-muted">ê³ ê° ë¦¬ë·°ë¥¼ í™•ì¸í•˜ê³  AI ë‹µê¸€ì„ ìƒì„±/ë“±ë¡í•˜ì„¸ìš”</p>
            <button onclick="toggleDebug()" class="btn btn-sm btn-secondary">ë””ë²„ê·¸ í† ê¸€</button>
        </div>
        
        <!-- í†µê³„ ëŒ€ì‹œë³´ë“œ -->
        <div id="statsSection" class="row mb-4" style="display: none;">
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="totalReviews">0</h3>
                    <p>ì „ì²´ ë¦¬ë·°</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <h3 id="avgRating">0.0</h3>
                    <p>í‰ê·  ë³„ì </p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                    <h3 id="replyRate">0%</h3>
                    <p>ë‹µë³€ìœ¨</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                    <h3 id="pendingReviews">0</h3>
                    <p>ë¯¸ë‹µë³€ ë¦¬ë·°</p>
                </div>
            </div>
        </div>
        
        <!-- í•„í„° ì„¹ì…˜ -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">ë§¤ì¥ ì„ íƒ</label>
                        <select id="storeSelect" class="form-control">
                            <option value="">ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">ë‹µë³€ ìƒíƒœ</label>
                        <select id="statusFilter" class="form-control">
                            <option value="">ì „ì²´</option>
                            <option value="pending">ë¯¸ë‹µë³€</option>
                            <option value="generated">AI ìƒì„±ë¨</option>
                            <option value="ready_to_post">ë“±ë¡ ì¤€ë¹„</option>
                            <option value="posted">ë‹µë³€ì™„ë£Œ</option>
                            <option value="failed">ì‹¤íŒ¨</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">ë³„ì </label>
                        <select id="ratingFilter" class="form-control">
                            <option value="">ì „ì²´</option>
                            <option value="5">â­â­â­â­â­ (5ì )</option>
                            <option value="4">â­â­â­â­ (4ì )</option>
                            <option value="3">â­â­â­ (3ì )</option>
                            <option value="2">â­â­ (2ì )</option>
                            <option value="1">â­ (1ì )</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label class="form-label">&nbsp;</label>
                        <button id="refreshBtn" class="btn btn-primary btn-block">
                            <i class="bi bi-arrow-clockwise"></i> ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ì¼ê´„ ì²˜ë¦¬ ì„¹ì…˜ -->
        <div id="batchActionsSection" class="batch-actions" style="display: none;">
            <h6><i class="bi bi-lightning"></i> ì¼ê´„ ë‹µê¸€ ë“±ë¡</h6>
            <div class="d-flex gap-2 flex-wrap">
                <button id="batchPostAll" class="btn btn-primary btn-sm" data-store-code="">
                    <i class="bi bi-send-fill"></i> ì„ íƒëœ ë§¤ì¥ì˜ ëª¨ë“  ë‹µê¸€ ë“±ë¡
                </button>
                <button id="batchPostGenerated" class="btn btn-info btn-sm" data-store-code="">
                    <i class="bi bi-robot"></i> AI ìƒì„±ëœ ë‹µê¸€ë§Œ ë“±ë¡
                </button>
                <button id="batchPostReady" class="btn btn-success btn-sm" data-store-code="">
                    <i class="bi bi-check-circle"></i> ë“±ë¡ ì¤€ë¹„ëœ ë‹µê¸€ë§Œ ë“±ë¡
                </button>
            </div>
            <small class="text-muted">â€» ì¼ê´„ ë“±ë¡ì€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬ë˜ë©°, ì™„ë£Œ í›„ ì•Œë¦¼ìœ¼ë¡œ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
        </div>
        
        <!-- ë¦¬ë·° ëª©ë¡ -->
        <div id="reviewsList">
            <div class="text-center text-muted py-5">
                <i class="bi bi-chat-square-text" style="font-size: 3rem;"></i>
                <p class="mt-2">ë§¤ì¥ì„ ì„ íƒí•˜ì—¬ ë¦¬ë·°ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
            </div>
        </div>
        
        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <nav id="pagination" style="display: none;">
            <ul class="pagination justify-content-center">
                <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </ul>
        </nav>
    </div>
</div>

<!-- ë‹µê¸€ ë“±ë¡ í™•ì¸ ëª¨ë‹¬ -->
<div class="modal fade" id="postReplyModal" tabindex="-1" aria-labelledby="postReplyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="postReplyModalLabel">ğŸ“¤ ë‹µê¸€ ë“±ë¡ í™•ì¸</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>ì£¼ì˜:</strong> ë‹µê¸€ì„ ë“±ë¡í•˜ë©´ ì‹¤ì œ í”Œë«í¼(ë°°ë¯¼/ìš”ê¸°ìš”/ì¿ íŒ¡ì´ì¸ )ì— ê²Œì‹œë©ë‹ˆë‹¤.
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>ğŸ“ ì›ë³¸ ë¦¬ë·°</h6>
                        <div class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                            <div id="modalReviewContent">ë¦¬ë·° ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <span id="modalReviewAuthor"></span> | 
                                    <span id="modalReviewRating"></span> | 
                                    <span id="modalReviewDate"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>ğŸ’¬ ë“±ë¡í•  ë‹µê¸€</h6>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background-color: #f0f8ff;">
                            <div id="modalReplyContent">ë‹µê¸€ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <span id="modalReplyType"></span> | 
                                    <span id="modalReplyLength"></span>ì
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>ğŸ“‹ ë§¤ì¥ ì •ë³´</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <small><strong>ë§¤ì¥ëª…:</strong> <span id="modalStoreName"></span></small>
                        </div>
                        <div class="col-md-6">
                            <small><strong>í”Œë«í¼:</strong> <span id="modalPlatform"></span></small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> ì·¨ì†Œ
                </button>
                <button type="button" class="btn btn-success" id="confirmPostReplyBtn">
                    <i class="bi bi-send"></i> ë‹µê¸€ ë“±ë¡
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', path='js/reviews.js') }}"></script>
<script>
console.log('[Reviews] í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨');

// ì „ì—­ ë³€ìˆ˜
let currentStoreCode = '';
let currentPage = 0;
const pageSize = 20;

// ë””ë²„ê·¸ ê¸°ëŠ¥
function toggleDebug() {
    const debugInfo = document.getElementById('debugInfo');
    debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
}

function addDebugInfo(message) {
    const debugContent = document.getElementById('debugContent');
    if (debugContent) {
        const timestamp = new Date().toLocaleTimeString();
        debugContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        debugContent.scrollTop = debugContent.scrollHeight;
    }
}

// í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Reviews] DOM ë¡œë“œ ì™„ë£Œ');
    addDebugInfo('DOM ë¡œë“œ ì™„ë£Œ');
    checkAuthAndInit();
});

// ì¸ì¦ ì²´í¬ ë° ì´ˆê¸°í™”
async function checkAuthAndInit() {
    console.log('[Reviews] ì¸ì¦ ì²´í¬ ì‹œì‘');
    addDebugInfo('ì¸ì¦ ì²´í¬ ì‹œì‘');
    
    const token = getToken();
    
    if (!token) {
        console.log('[Reviews] í† í° ì—†ìŒ - ë¡œê·¸ì¸ ì•ˆë‚´ í‘œì‹œ');
        addDebugInfo('í† í° ì—†ìŒ - ë¡œê·¸ì¸ ì•ˆë‚´ í‘œì‹œ');
        document.getElementById('loginPrompt').style.display = 'block';
        document.getElementById('mainContent').style.display = 'none';
        return;
    }
    
    console.log('[Reviews] í† í° ìˆìŒ - ë©”ì¸ ì»¨í…ì¸  í‘œì‹œ');
    addDebugInfo('í† í° ìˆìŒ: ' + token.substring(0, 20) + '...');
    document.getElementById('loginPrompt').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    
    // ì´ˆê¸°í™”
    try {
        await loadStores();
        setupEventListeners();
        console.log('[Reviews] ì´ˆê¸°í™” ì™„ë£Œ');
        addDebugInfo('ì´ˆê¸°í™” ì™„ë£Œ');
    } catch (error) {
        console.error('[Reviews] ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        addDebugInfo('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
        if (error.message && error.message.includes('401')) {
            showAlert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'warning');
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        }
    }
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupEventListeners() {
    console.log('[Reviews] ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •');
    addDebugInfo('ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •');
    
    const storeSelect = document.getElementById('storeSelect');
    const statusFilter = document.getElementById('statusFilter');
    const ratingFilter = document.getElementById('ratingFilter');
    const refreshBtn = document.getElementById('refreshBtn');
    
    if (storeSelect) storeSelect.addEventListener('change', onStoreChange);
    if (statusFilter) statusFilter.addEventListener('change', loadReviews);
    if (ratingFilter) ratingFilter.addEventListener('change', loadReviews);
    if (refreshBtn) refreshBtn.addEventListener('click', refreshData);
}

// ë§¤ì¥ ëª©ë¡ ë¡œë“œ
async function loadStores() {
    console.log('[Reviews] ë§¤ì¥ ëª©ë¡ ë¡œë“œ ì‹œì‘');
    addDebugInfo('ë§¤ì¥ ëª©ë¡ ë¡œë“œ ì‹œì‘');
    
    try {
        const stores = await apiRequest('/stores');
        console.log('[Reviews] ë§¤ì¥ ëª©ë¡ ì‘ë‹µ:', stores);
        addDebugInfo('ë§¤ì¥ ëª©ë¡ ì‘ë‹µ: ' + JSON.stringify(stores).substring(0, 100) + '...');
        
        const select = document.getElementById('storeSelect');
        if (!select) {
            console.error('[Reviews] storeSelect ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            addDebugInfo('ERROR: storeSelect ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return;
        }
        
        // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ì˜µì…˜ ì œì™¸)
        while (select.options.length > 1) {
            select.remove(1);
        }
        
        // API ì‘ë‹µì´ ë°°ì—´ì¸ì§€ ê°ì²´ì¸ì§€ í™•ì¸
        const storeList = Array.isArray(stores) ? stores : (stores.stores || []);
        console.log('[Reviews] ì²˜ë¦¬í•  ë§¤ì¥ ëª©ë¡:', storeList);
        addDebugInfo('ë§¤ì¥ ëª©ë¡ ê°œìˆ˜: ' + storeList.length);
        
        storeList.forEach(store => {
            const option = document.createElement('option');
            option.value = store.store_code;
            option.textContent = store.store_name + ' (' + store.platform + ')';
            select.appendChild(option);
        });
        
        if (storeList.length === 0) {
            showAlert('ë“±ë¡ëœ ë§¤ì¥ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë§¤ì¥ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.', 'info');
            addDebugInfo('ë§¤ì¥ì´ ì—†ìŒ - ì•Œë¦¼ í‘œì‹œ');
        }
    } catch (error) {
        console.error('[Reviews] ë§¤ì¥ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        addDebugInfo('ë§¤ì¥ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
        showAlert('ë§¤ì¥ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
    }
}

// ë§¤ì¥ ë³€ê²½ì‹œ
async function onStoreChange() {
    currentStoreCode = document.getElementById('storeSelect').value;
    console.log('[Reviews] ì„ íƒëœ ë§¤ì¥:', currentStoreCode);
    addDebugInfo('ì„ íƒëœ ë§¤ì¥: ' + currentStoreCode);
    
    if (currentStoreCode) {
        document.getElementById('statsSection').style.display = 'flex';
        document.getElementById('batchActionsSection').style.display = 'block';
        await Promise.all([loadStats(), loadReviews()]);
    } else {
        document.getElementById('statsSection').style.display = 'none';
        document.getElementById('batchActionsSection').style.display = 'none';
        document.getElementById('reviewsList').innerHTML = 
            '<div class="text-center text-muted py-5">' +
                '<i class="bi bi-chat-square-text" style="font-size: 3rem;"></i>' +
                '<p class="mt-2">ë§¤ì¥ì„ ì„ íƒí•˜ì—¬ ë¦¬ë·°ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>' +
            '</div>';
    }
}

// í†µê³„ ë¡œë“œ
async function loadStats() {
    if (!currentStoreCode) return;
    
    console.log('[Reviews] í†µê³„ ë¡œë“œ ì‹œì‘');
    addDebugInfo('í†µê³„ ë¡œë“œ ì‹œì‘ - store_code: ' + currentStoreCode);
    
    try {
        const stats = await apiRequest('/reviews/stats/' + currentStoreCode);
        console.log('[Reviews] í†µê³„ ì‘ë‹µ:', stats);
        addDebugInfo('í†µê³„ ì‘ë‹µ: ' + JSON.stringify(stats));
        
        document.getElementById('totalReviews').textContent = stats.total_reviews || 0;
        document.getElementById('avgRating').textContent = (stats.avg_rating || 0).toFixed(1);
        document.getElementById('replyRate').textContent = (stats.reply_rate || 0) + '%';
        document.getElementById('pendingReviews').textContent = stats.pending_reviews || 0;
        
        addDebugInfo('í†µê³„ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        
    } catch (error) {
        console.error('[Reviews] í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
        addDebugInfo('í†µê³„ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
        // í†µê³„ ë¡œë“œ ì‹¤íŒ¨í•´ë„ ë¦¬ë·° ëª©ë¡ì€ í‘œì‹œ
    }
}

// ë¦¬ë·° ëª©ë¡ ë¡œë“œ
async function loadReviews() {
    if (!currentStoreCode) return;
    
    console.log('[Reviews] ë¦¬ë·° ëª©ë¡ ë¡œë“œ ì‹œì‘');
    addDebugInfo('ë¦¬ë·° ëª©ë¡ ë¡œë“œ ì‹œì‘');
    
    const status = document.getElementById('statusFilter').value;
    const rating = document.getElementById('ratingFilter').value;
    
    // ë¡œë”© í‘œì‹œ
    document.getElementById('reviewsList').innerHTML = '<div class="text-center py-5"><div class="spinner-border"></div><p>ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
    
    try {
        const params = new URLSearchParams({
            limit: pageSize,
            offset: currentPage * pageSize
        });
        
        if (status) params.append('status', status);
        if (rating) params.append('rating', rating);
        
        const url = '/reviews/' + currentStoreCode + '?' + params;
        addDebugInfo('ë¦¬ë·° ìš”ì²­ URL: ' + url);
        
        const reviews = await apiRequest(url);
        console.log('[Reviews] ë¦¬ë·° ëª©ë¡ ì‘ë‹µ:', reviews);
        addDebugInfo('ë¦¬ë·° ëª©ë¡ ì‘ë‹µ ê°œìˆ˜: ' + (Array.isArray(reviews) ? reviews.length : 'N/A'));
        
        if (Array.isArray(reviews) && reviews.length > 0) {
            displayReviews(reviews);
            addDebugInfo('ë¦¬ë·° UI ë Œë”ë§ ì™„ë£Œ');
        } else {
            document.getElementById('reviewsList').innerHTML = 
                '<div class="text-center text-muted py-5">' +
                    '<i class="bi bi-inbox" style="font-size: 3rem;"></i>' +
                    '<p class="mt-2">ì¡°ê±´ì— ë§ëŠ” ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>' +
                '</div>';
            addDebugInfo('ë¦¬ë·° ì—†ìŒ - ë¹ˆ ìƒíƒœ í‘œì‹œ');
        }
        
    } catch (error) {
        console.error('[Reviews] ë¦¬ë·° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        addDebugInfo('ë¦¬ë·° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
        document.getElementById('reviewsList').innerHTML = 
            '<div class="text-center text-muted py-5">' +
                '<i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: var(--danger-color);"></i>' +
                '<p class="mt-2">ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p>' +
                '<p class="small">' + error.message + '</p>' +
                '<button class="btn btn-primary btn-sm mt-2" onclick="loadReviews()">ë‹¤ì‹œ ì‹œë„</button>' +
            '</div>';
    }
}

// ë¦¬ë·° ëª©ë¡ í‘œì‹œ (ë‹µê¸€ ë“±ë¡ ê¸°ëŠ¥ í¬í•¨)
function displayReviews(reviews) {
    const reviewsHtml = reviews.map(review => {
        // AI ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤
        let aiControls = '';
        if (review.response_status === 'pending') {
            aiControls = `
                <div class="ai-controls">
                    <button class="btn-ai" onclick="generateAIReply('${review.review_id}')">
                        ğŸ¤– AI ë‹µê¸€ ìƒì„±
                    </button>
                </div>`;
        } else if (review.response_status === 'generated') {
            aiControls = `
                <div class="ai-controls">
                    <button class="btn-regenerate" onclick="regenerateAIReply('${review.review_id}')">
                        ğŸ”„ ì¬ìƒì„±
                    </button>
                    <button class="post-reply-btn" 
                            data-review-id="${review.review_id}"
                            data-reply-content="${escapeHtml(review.final_response || review.ai_response || '')}"
                            data-store-name="${escapeHtml(currentStoreCode)}"
                            data-platform="${review.platform || ''}">
                        ğŸ“¤ ë‹µê¸€ ë“±ë¡
                    </button>
                </div>`;
        } else if (review.response_status === 'ready_to_post') {
            aiControls = `
                <div class="ai-controls">
                    <button class="post-reply-btn" 
                            data-review-id="${review.review_id}"
                            data-reply-content="${escapeHtml(review.final_response || '')}"
                            data-store-name="${escapeHtml(currentStoreCode)}"
                            data-platform="${review.platform || ''}">
                        ğŸ“¤ ë‹µê¸€ ë“±ë¡
                    </button>
                </div>`;
        } else if (review.response_status === 'posted') {
            aiControls = `
                <div class="ai-controls">
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle"></i> ë“±ë¡ì™„ë£Œ
                    </span>
                </div>`;
        } else if (review.response_status === 'failed') {
            aiControls = `
                <div class="ai-controls">
                    <button class="retry-reply-btn btn btn-warning btn-sm" 
                            data-review-id="${review.review_id}">
                        <i class="bi bi-arrow-clockwise"></i> ì¬ì‹œë„
                    </button>
                </div>`;
        }

        // ë‹µê¸€ ì„¹ì…˜
        const replySection = review.final_response || review.ai_response ? 
            `<div class="ai-reply-section">
                <small class="text-muted">ë‹µê¸€:</small>
                <p class="mb-1">${escapeHtml(review.final_response || review.ai_response)}</p>
                ${(review.response_method === 'ai_auto' || review.response_method === 'ai_retry') ? 
                    `<div class="ai-info">
                        <span>ğŸ¤– AI ìƒì„± ë‹µê¸€</span>
                        <span class="text-muted">${formatDate(review.response_at || review.created_at)}</span>
                    </div>` : ''
                }
            </div>` : '';

        return `<div class="review-card" data-review-id="${review.review_id}">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <span class="platform-badge platform-${review.platform || 'unknown'}">${review.platform || 'N/A'}</span>
                    <span class="status-badge status-${review.response_status || 'unknown'}">${getStatusText(review.response_status || 'unknown')}</span>
                </div>
                <div class="text-muted">${formatDate(review.review_date || new Date().toISOString())}</div>
            </div>
            <div class="mb-2">
                <strong>${escapeHtml(review.review_name || 'ìµëª…')}</strong>
                <span class="rating-stars ml-2">${'â˜…'.repeat(review.rating || 0)}${'â˜†'.repeat(5-(review.rating || 0))}</span>
            </div>
            ${review.ordered_menu ? `<p class="text-muted small mb-2">ì£¼ë¬¸: ${escapeHtml(review.ordered_menu)}</p>` : ''}
            <p class="mb-3 review-text">${escapeHtml(review.review_content || '')}</p>
            ${aiControls}
            ${replySection}
        </div>`;
    }).join('');
    
    document.getElementById('reviewsList').innerHTML = reviewsHtml;
    
    // ë‹µê¸€ ë“±ë¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    setupPostReplyButtons();
}

// ë‹µê¸€ ë“±ë¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
function setupPostReplyButtons() {
    document.querySelectorAll('.post-reply-btn').forEach(button => {
        button.addEventListener('click', function() {
            const reviewId = this.dataset.reviewId;
            const replyContent = this.dataset.replyContent;
            const storeName = this.dataset.storeName;
            const platform = this.dataset.platform;
            
            // ëª¨ë‹¬ì— ì •ë³´ í‘œì‹œ
            showPostReplyModal(reviewId, replyContent, storeName, platform);
        });
    });
    
    // ì¬ì‹œë„ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.querySelectorAll('.retry-reply-btn').forEach(button => {
        button.addEventListener('click', function() {
            handleRetryReply(this.dataset.reviewId);
        });
    });
}

// ë‹µê¸€ ë“±ë¡ ëª¨ë‹¬ í‘œì‹œ
async function showPostReplyModal(reviewId, replyContent, storeName, platform) {
    try {
        // ë¦¬ë·° ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const reviewInfo = await apiRequest(`/test-reply-posting/${reviewId}/info`);
        
        // ëª¨ë‹¬ ë‚´ìš© ì—…ë°ì´íŠ¸
        document.getElementById('modalReviewContent').innerHTML = escapeHtml(reviewInfo.review_content || '');
        document.getElementById('modalReviewAuthor').textContent = reviewInfo.review_name || 'ìµëª…';
        document.getElementById('modalReviewRating').textContent = 'â˜…'.repeat(reviewInfo.rating || 0) + 'â˜†'.repeat(5-(reviewInfo.rating || 0));
        document.getElementById('modalReviewDate').textContent = formatDate(reviewInfo.review_date);
        
        document.getElementById('modalReplyContent').innerHTML = escapeHtml(replyContent);
        document.getElementById('modalReplyType').textContent = getReplyTypeText(reviewInfo.response_method || 'ai_auto');
        document.getElementById('modalReplyLength').textContent = (replyContent || '').length;
        
        document.getElementById('modalStoreName').textContent = storeName;
        document.getElementById('modalPlatform').textContent = getPlatformText(platform);
        
        // ëª¨ë‹¬ í‘œì‹œ
        const modal = new bootstrap.Modal(document.getElementById('postReplyModal'));
        modal.show();
        
        // í™•ì¸ ë²„íŠ¼ì— ë°ì´í„° ì €ì¥
        const confirmBtn = document.getElementById('confirmPostReplyBtn');
        confirmBtn.dataset.reviewId = reviewId;
        confirmBtn.dataset.replyContent = replyContent;
        
    } catch (error) {
        console.error('ë¦¬ë·° ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        showAlert('ë¦¬ë·° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'danger');
    }
}

// ë‹µê¸€ ë“±ë¡ í™•ì¸ ì²˜ë¦¬
document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'confirmPostReplyBtn') {
        handleConfirmPostReply(e.target);
    }
});

async function handleConfirmPostReply(button) {
    const reviewId = button.dataset.reviewId;
    const replyContent = button.dataset.replyContent;
    
    if (!reviewId || !replyContent) {
        showAlert('ì˜¤ë¥˜: ë“±ë¡í•  ë‹µê¸€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'danger');
        return;
    }
    
    const originalText = button.innerHTML;
    
    try {
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ë“±ë¡ ì¤‘...';
        
        addDebugInfo(`ë‹µê¸€ ë“±ë¡ ì‹œì‘: ${reviewId}`);
        
        const response = await fetch(`/api/reply-posting/${reviewId}/submit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify({
                reply_content: replyContent,
                auto_submit: true
            })
        });
        
        const result = await response.json();
        addDebugInfo(`ë‹µê¸€ ë“±ë¡ ì‘ë‹µ: ${JSON.stringify(result)}`);
        
        if (response.ok && result.success) {
            showAlert('ë‹µê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
            
            // ëª¨ë‹¬ ë‹«ê¸°
            const modal = bootstrap.Modal.getInstance(document.getElementById('postReplyModal'));
            modal.hide();
            
            // ë¦¬ë·° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            setTimeout(() => {
                loadReviews();
                loadStats();
            }, 1500);
            
        } else {
            throw new Error(result.detail || result.message || 'ë‹µê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
    } catch (error) {
        console.error('ë‹µê¸€ ë“±ë¡ ì˜¤ë¥˜:', error);
        addDebugInfo(`ë‹µê¸€ ë“±ë¡ ì‹¤íŒ¨: ${error.message}`);
        showAlert(`ë‹µê¸€ ë“±ë¡ ì‹¤íŒ¨: ${error.message}`, 'danger');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// AI ë‹µê¸€ ìƒì„±
async function generateAIReply(reviewId) {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<span class="loading"></span>ìƒì„± ì¤‘...';
    button.disabled = true;
    
    addDebugInfo('AI ë‹µê¸€ ìƒì„± ì‹œì‘: ' + reviewId);
    
    try {
        const response = await fetch('/api/reviews/' + reviewId + '/generate-reply', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + getToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'HTTP ' + response.status);
        }
        
        const result = await response.json();
        addDebugInfo('AI ë‹µê¸€ ìƒì„± ì™„ë£Œ: ' + JSON.stringify(result));
        
        if (result.success) {
            showAlert(`AI ë‹µê¸€ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\ní’ˆì§ˆì ìˆ˜: ${(result.quality_score * 100).toFixed(1)}%`, 'success');
            loadReviews(); // ìƒˆë¡œê³ ì¹¨
        } else {
            throw new Error(result.message || 'ë‹µê¸€ ìƒì„± ì‹¤íŒ¨');
        }
        
    } catch (error) {
        console.error('AI ë‹µê¸€ ìƒì„± ì‹¤íŒ¨:', error);
        addDebugInfo('AI ë‹µê¸€ ìƒì„± ì‹¤íŒ¨: ' + error.message);
        showAlert('ë‹µê¸€ ìƒì„± ì‹¤íŒ¨: ' + error.message, 'danger');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// AI ë‹µê¸€ ì¬ìƒì„±
async function regenerateAIReply(reviewId) {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<span class="loading"></span>ì¬ìƒì„± ì¤‘...';
    button.disabled = true;
    
    addDebugInfo('AI ë‹µê¸€ ì¬ìƒì„± ì‹œì‘: ' + reviewId);
    
    try {
        const response = await fetch('/api/reviews/' + reviewId + '/regenerate-reply', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + getToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'HTTP ' + response.status);
        }
        
        const result = await response.json();
        addDebugInfo('AI ë‹µê¸€ ì¬ìƒì„± ì™„ë£Œ: ' + JSON.stringify(result));
        
        if (result.success) {
            showAlert(`AI ë‹µê¸€ì´ ì¬ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\ní’ˆì§ˆì ìˆ˜: ${(result.quality_score * 100).toFixed(1)}%`, 'success');
            loadReviews(); // ìƒˆë¡œê³ ì¹¨
        } else {
            throw new Error(result.message || 'ë‹µê¸€ ì¬ìƒì„± ì‹¤íŒ¨');
        }
        
    } catch (error) {
        console.error('AI ë‹µê¸€ ì¬ìƒì„± ì‹¤íŒ¨:', error);
        addDebugInfo('AI ë‹µê¸€ ì¬ìƒì„± ì‹¤íŒ¨: ' + error.message);
        showAlert('ë‹µê¸€ ì¬ìƒì„± ì‹¤íŒ¨: ' + error.message, 'danger');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// ì¼ê´„ ë“±ë¡ ë²„íŠ¼ ì´ë²¤íŠ¸ (ê¸°ì¡´ ì½”ë“œì—ì„œ ì¶”ê°€)
document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'batchPostAll') {
        handleBatchPost('all', 'ëª¨ë“  ë‹µê¸€');
    } else if (e.target && e.target.id === 'batchPostGenerated') {
        handleBatchPost('generated', 'AI ìƒì„±ëœ ë‹µê¸€');
    } else if (e.target && e.target.id === 'batchPostReady') {
        handleBatchPost('ready_to_post', 'ë“±ë¡ ì¤€ë¹„ëœ ë‹µê¸€');
    }
});

async function handleBatchPost(type, description) {
    if (!currentStoreCode) {
        showAlert('ë§¤ì¥ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    
    if (!confirm(`ì´ ë§¤ì¥ì˜ ${description}ì„(ë¥¼) ëª¨ë‘ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» ì‹¤ì œ í”Œë«í¼ì— ë‹µê¸€ì´ ê²Œì‹œë©ë‹ˆë‹¤.`)) {
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    
    try {
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ì¼ê´„ ë“±ë¡ ì¤‘...';
        
        addDebugInfo(`ì¼ê´„ ë“±ë¡ ì‹œì‘: ${type} - ${currentStoreCode}`);
        
        const filters = {};
        if (type === 'generated') {
            filters.status = ['generated'];
        } else if (type === 'ready_to_post') {
            filters.status = ['ready_to_post'];
        } else {
            filters.status = ['generated', 'ready_to_post'];
        }
        
        const response = await fetch(`/api/reply-posting/batch/${currentStoreCode}/submit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify({
                filters: filters,
                auto_submit: true
            })
        });
        
        const result = await response.json();
        addDebugInfo(`ì¼ê´„ ë“±ë¡ ì‘ë‹µ: ${JSON.stringify(result)}`);
        
        if (response.ok && result.success) {
            const message = `${description} ${result.posted_count}ê°œê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰
            ${result.failed_count > 0 ? `\nì‹¤íŒ¨: ${result.failed_count}ê°œ` : ''}`;
            
            showAlert(message, 'success');
            
            // ë¦¬ë·° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            setTimeout(() => {
                loadReviews();
                loadStats();
            }, 2000);
            
        } else {
            throw new Error(result.detail || result.message || 'ì¼ê´„ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
    } catch (error) {
        console.error('ì¼ê´„ ë“±ë¡ ì˜¤ë¥˜:', error);
        addDebugInfo(`ì¼ê´„ ë“±ë¡ ì‹¤íŒ¨: ${error.message}`);
        showAlert(`ì¼ê´„ ë“±ë¡ ì‹¤íŒ¨: ${error.message}`, 'danger');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

function formatDate(dateStr) {
    try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('ko-KR', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    } catch (e) {
        return dateStr;
    }
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'ë¯¸ë‹µë³€',
        'generated': 'AI ìƒì„±ë¨',
        'ready_to_post': 'ë“±ë¡ ì¤€ë¹„',
        'posted': 'ë‹µë³€ì™„ë£Œ',
        'failed': 'ì‹¤íŒ¨',
        'unknown': 'ì•Œ ìˆ˜ ì—†ìŒ'
    };
    return statusMap[status] || status;
}

function getReplyTypeText(method) {
    const methodMap = {
        'ai_auto': 'AI ìë™ìƒì„±',
        'ai_manual': 'AI ìˆ˜ë™ì„ íƒ',
        'ai_retry': 'AI ì¬ìƒì„±',
        'full_manual': 'ì™„ì „ìˆ˜ë™'
    };
    return methodMap[method] || method;
}

function getPlatformText(platform) {
    const platformMap = {
        'baemin': 'ë°°ë‹¬ì˜ë¯¼ì¡±',
        'yogiyo': 'ìš”ê¸°ìš”',
        'coupang': 'ì¿ íŒ¡ì´ì¸ '
    };
    return platformMap[platform] || platform;
}

async function handleRetryReply(reviewId) {
    try {
        const response = await fetch(`/api/reply-status/${reviewId}/retry`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${getToken()}`,
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showAlert('ë‹µê¸€ ì¬ì‹œë„ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            setTimeout(() => {
                loadReviews();
            }, 3000);
        } else {
            throw new Error(result.detail || 'ì¬ì‹œë„ ì‹¤íŒ¨');
        }
        
    } catch (error) {
        console.error('ë‹µê¸€ ì¬ì‹œë„ ì˜¤ë¥˜:', error);
        showAlert(`ë‹µê¸€ ì¬ì‹œë„ ì‹¤íŒ¨: ${error.message}`, 'danger');
    }
}

async function refreshData() {
    console.log('[Reviews] ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
    addDebugInfo('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
    
    if (currentStoreCode) {
        await Promise.all([loadStats(), loadReviews()]);
        showAlert('ë°ì´í„°ë¥¼ ìƒˆë¡œê³ ì¹¨í–ˆìŠµë‹ˆë‹¤', 'success');
        addDebugInfo('ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
    }
}
</script>
{% endblock %}