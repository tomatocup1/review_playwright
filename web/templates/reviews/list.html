{% extends "base.html" %}

{% block title %}리뷰 관리 - {{ super() }}{% endblock %}

{% block extra_css %}
<style>
    /* 리뷰 페이지 전용 스타일 */
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1rem;
    }
    
    .stats-card h3 {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .filter-section {
        background-color: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .review-card {
        background-color: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }
    
    .review-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .rating-stars {
        color: #f59e0b;
    }
    
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .status-pending {
        background-color: #fef3c7;
        color: #92400e;
    }
    
    .status-posted {
        background-color: #d1fae5;
        color: #065f46;
    }
    
    .status-failed {
        background-color: #fee2e2;
        color: #991b1b;
    }
    
    .platform-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .platform-baemin {
        background-color: #00d4d4;
        color: white;
    }
    
    .platform-yogiyo {
        background-color: #fa0050;
        color: white;
    }
    
    .platform-coupang {
        background-color: #5a2e0e;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- 페이지 헤더 -->
    <div class="mb-4">
        <h1 class="mb-2">리뷰 관리</h1>
        <p class="text-muted">고객 리뷰를 확인하고 답글을 작성하세요</p>
    </div>
    
    <!-- 통계 대시보드 -->
    <div id="statsSection" class="row mb-4" style="display: none;">
        <div class="col-md-3">
            <div class="stats-card">
                <h3 id="totalReviews">0</h3>
                <p>전체 리뷰</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <h3 id="avgRating">0.0</h3>
                <p>평균 별점</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                <h3 id="replyRate">0%</h3>
                <p>답변율</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                <h3 id="pendingReviews">0</h3>
                <p>미답변 리뷰</p>
            </div>
        </div>
    </div>
    
    <!-- 필터 섹션 -->
    <div class="filter-section">
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="form-label">매장 선택</label>
                    <select id="storeSelect" class="form-control">
                        <option value="">매장을 선택하세요</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="form-label">답변 상태</label>
                    <select id="statusFilter" class="form-control">
                        <option value="">전체</option>
                        <option value="pending">미답변</option>
                        <option value="posted">답변완료</option>
                        <option value="failed">실패</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="form-label">별점</label>
                    <select id="ratingFilter" class="form-control">
                        <option value="">전체</option>
                        <option value="5">⭐⭐⭐⭐⭐ (5점)</option>
                        <option value="4">⭐⭐⭐⭐ (4점)</option>
                        <option value="3">⭐⭐⭐ (3점)</option>
                        <option value="2">⭐⭐ (2점)</option>
                        <option value="1">⭐ (1점)</option>
                    </select>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label class="form-label">&nbsp;</label>
                    <button id="refreshBtn" class="btn btn-primary btn-block">
                        <i class="bi bi-arrow-clockwise"></i> 새로고침
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 리뷰 목록 -->
    <div id="reviewsList">
        <div class="text-center text-muted py-5">
            <i class="bi bi-chat-square-text" style="font-size: 3rem;"></i>
            <p class="mt-2">매장을 선택하여 리뷰를 확인하세요</p>
        </div>
    </div>
    
    <!-- 페이지네이션 -->
    <nav id="pagination" style="display: none;">
        <ul class="pagination justify-content-center">
            <!-- 페이지네이션 버튼들이 여기에 동적으로 추가됩니다 -->
        </ul>
    </nav>
</div>

<!-- 답글 작성 모달 -->
<div id="replyModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeReplyModal()">&times;</span>
        <h2 class="mb-3">답글 작성</h2>
        
        <div id="reviewInfo" class="mb-3">
            <!-- 리뷰 정보가 여기에 표시됩니다 -->
        </div>
        
        <form id="replyForm">
            <input type="hidden" id="replyReviewId">
            
            <div class="form-group">
                <label class="form-label">답글 유형</label>
                <select id="replyType" class="form-control">
                    <option value="full_manual">직접 작성</option>
                    <option value="ai_manual">AI 제안 수정</option>
                    <option value="ai_auto">AI 자동 작성</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">답글 내용</label>
                <textarea id="replyContent" class="form-control" rows="5" placeholder="답글을 입력하세요..." required></textarea>
                <small class="text-muted">
                    <span id="charCount">0</span> / 1000자
                </small>
            </div>
            
            <div class="text-right">
                <button type="button" class="btn btn-secondary" onclick="closeReplyModal()">취소</button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-send"></i> 답글 등록
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 전역 변수
let currentStoreCode = '';
let currentPage = 0;
const pageSize = 20;

// 페이지 로드시 초기화
document.addEventListener('DOMContentLoaded', function() {
    loadStores();
    setupEventListeners();
});

// 이벤트 리스너 설정
function setupEventListeners() {
    document.getElementById('storeSelect').addEventListener('change', onStoreChange);
    document.getElementById('statusFilter').addEventListener('change', loadReviews);
    document.getElementById('ratingFilter').addEventListener('change', loadReviews);
    document.getElementById('refreshBtn').addEventListener('click', refreshData);
    document.getElementById('replyForm').addEventListener('submit', submitReply);
    document.getElementById('replyContent').addEventListener('input', updateCharCount);
}

// 매장 목록 로드
async function loadStores() {
    try {
        const stores = await apiRequest('/api/stores');
        const select = document.getElementById('storeSelect');
        
        stores.forEach(store => {
            const option = document.createElement('option');
            option.value = store.store_code;
            option.textContent = `${store.store_name} (${store.platform})`;
            select.appendChild(option);
        });
    } catch (error) {
        showAlert('매장 목록을 불러오는데 실패했습니다: ' + error.message, 'danger');
    }
}

// 매장 변경시
async function onStoreChange() {
    currentStoreCode = document.getElementById('storeSelect').value;
    currentPage = 0;
    
    if (currentStoreCode) {
        document.getElementById('statsSection').style.display = 'flex';
        await Promise.all([loadStats(), loadReviews()]);
    } else {
        document.getElementById('statsSection').style.display = 'none';
        document.getElementById('reviewsList').innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-chat-square-text" style="font-size: 3rem;"></i>
                <p class="mt-2">매장을 선택하여 리뷰를 확인하세요</p>
            </div>
        `;
        document.getElementById('pagination').style.display = 'none';
    }
}

// 통계 로드
async function loadStats() {
    try {
        const stats = await apiRequest(`/api/reviews/stats/${currentStoreCode}`);
        
        document.getElementById('totalReviews').textContent = stats.total_reviews || 0;
        document.getElementById('avgRating').textContent = (stats.avg_rating || 0).toFixed(1);
        document.getElementById('replyRate').textContent = (stats.reply_rate || 0) + '%';
        document.getElementById('pendingReviews').textContent = stats.pending_reviews || 0;
    } catch (error) {
        console.error('통계 로드 실패:', error);
    }
}

// 리뷰 목록 로드
async function loadReviews() {
    if (!currentStoreCode) return;
    
    const status = document.getElementById('statusFilter').value;
    const rating = document.getElementById('ratingFilter').value;
    
    // 로딩 표시
    document.getElementById('reviewsList').innerHTML = '<div class="text-center py-5"><div class="spinner"></div></div>';
    
    try {
        const params = new URLSearchParams({
            limit: pageSize,
            offset: currentPage * pageSize
        });
        
        if (status) params.append('status', status);
        if (rating) params.append('rating', rating);
        
        const reviews = await apiRequest(`/api/reviews/${currentStoreCode}?${params}`);
        
        renderReviews(reviews);
        updatePagination(reviews.length);
        
    } catch (error) {
        showAlert('리뷰를 불러오는데 실패했습니다: ' + error.message, 'danger');
    }
}

// 리뷰 렌더링
function renderReviews(reviews) {
    const container = document.getElementById('reviewsList');
    
    if (reviews.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-2">조건에 맞는 리뷰가 없습니다</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = reviews.map(review => `
        <div class="review-card">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <span class="platform-badge platform-${review.platform}">${review.platform}</span>
                    <span class="status-badge status-${review.response_status}">
                        ${getStatusText(review.response_status)}
                    </span>
                </div>
                <div class="text-muted">
                    ${formatDate(review.review_date)}
                </div>
            </div>
            
            <div class="mb-2">
                <strong>${review.review_name}</strong>
                <span class="rating-stars ml-2">${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}</span>
            </div>
            
            ${review.ordered_menu ? `<p class="text-muted small mb-2">주문: ${review.ordered_menu}</p>` : ''}
            
            <p class="mb-3">${review.review_content}</p>
            
            ${review.final_response ? `
                <div class="bg-light p-3 rounded mb-2">
                    <small class="text-muted">답글:</small>
                    <p class="mb-0">${review.final_response}</p>
                </div>
            ` : ''}
            
            ${review.response_status === 'pending' ? `
                <button class="btn btn-primary btn-sm" onclick="openReplyModal('${review.review_id}')">
                    <i class="bi bi-reply"></i> 답글 작성
                </button>
            ` : ''}
            
            ${review.boss_reply_needed ? `
                <span class="text-danger small ml-2">
                    <i class="bi bi-exclamation-triangle"></i> 사장님 확인 필요
                </span>
            ` : ''}
        </div>
    `).join('');
}

// 날짜 포맷
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('ko-KR', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

// 상태 텍스트
function getStatusText(status) {
    const statusMap = {
        'pending': '미답변',
        'posted': '답변완료',
        'failed': '실패'
    };
    return statusMap[status] || status;
}

// 페이지네이션 업데이트
function updatePagination(itemCount) {
    const pagination = document.getElementById('pagination');
    
    if (itemCount < pageSize && currentPage === 0) {
        pagination.style.display = 'none';
        return;
    }
    
    pagination.style.display = 'block';
    const ul = pagination.querySelector('ul');
    ul.innerHTML = '';
    
    // 이전 페이지
    if (currentPage > 0) {
        ul.innerHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">이전</a>
            </li>
        `;
    }
    
    // 페이지 번호
    for (let i = Math.max(0, currentPage - 2); i <= currentPage + 2; i++) {
        ul.innerHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i + 1}</a>
            </li>
        `;
    }
    
    // 다음 페이지
    if (itemCount === pageSize) {
        ul.innerHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">다음</a>
            </li>
        `;
    }
}

// 페이지 변경
function changePage(page) {
    currentPage = page;
    loadReviews();
    window.scrollTo(0, 0);
}

// 답글 모달 열기
async function openReplyModal(reviewId) {
    document.getElementById('replyReviewId').value = reviewId;
    document.getElementById('replyModal').style.display = 'block';
    
    // 리뷰 정보 표시
    try {
        const reviews = await apiRequest(`/api/reviews/${currentStoreCode}?limit=100`);
        const review = reviews.find(r => r.review_id === reviewId);
        
        if (review) {
            document.getElementById('reviewInfo').innerHTML = `
                <div class="bg-light p-3 rounded">
                    <strong>${review.review_name}</strong>
                    <span class="rating-stars ml-2">${'★'.repeat(review.rating)}</span>
                    <p class="mb-0 mt-2">${review.review_content}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('리뷰 정보 로드 실패:', error);
    }
}

// 답글 모달 닫기
function closeReplyModal() {
    document.getElementById('replyModal').style.display = 'none';
    document.getElementById('replyForm').reset();
    updateCharCount();
}

// 글자수 업데이트
function updateCharCount() {
    const content = document.getElementById('replyContent').value;
    document.getElementById('charCount').textContent = content.length;
}

// 답글 제출
async function submitReply(e) {
    e.preventDefault();
    
    const reviewId = document.getElementById('replyReviewId').value;
    const replyContent = document.getElementById('replyContent').value.trim();
    const replyType = document.getElementById('replyType').value;
    
    if (!replyContent) {
        showAlert('답글 내용을 입력해주세요', 'warning');
        return;
    }
    
    try {
        const response = await apiRequest(`/api/reviews/${reviewId}/reply`, {
            method: 'POST',
            body: JSON.stringify({
                reply_content: replyContent,
                reply_type: replyType
            })
        });
        
        showAlert('답글이 성공적으로 등록되었습니다', 'success');
        closeReplyModal();
        
        // 목록 새로고침
        await Promise.all([loadStats(), loadReviews()]);
        
    } catch (error) {
        showAlert('답글 등록에 실패했습니다: ' + error.message, 'danger');
    }
}

// 데이터 새로고침
async function refreshData() {
    if (!currentStoreCode) return;
    
    const btn = document.getElementById('refreshBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> 새로고침 중...';
    
    try {
        await Promise.all([loadStats(), loadReviews()]);
        showAlert('데이터를 새로고침했습니다', 'success');
    } catch (error) {
        showAlert('새로고침 실패: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 새로고침';
    }
}

// 모달 외부 클릭시 닫기
window.onclick = function(event) {
    if (event.target == document.getElementById('replyModal')) {
        closeReplyModal();
    }
}
</script>
{% endblock %}