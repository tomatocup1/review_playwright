{% extends \"base.html\" %}\n\n{% block title %}리뷰 관리 - {{ super() }}{% endblock %}\n\n{% block extra_css %}\n<link rel=\"stylesheet\" href=\"{{ url_for('static', path='/css/reviews.css') }}\">\n{% endblock %}\n\n{% block content %}\n<div class=\"container\">\n    <!-- 로그인 체크 -->\n    <div id=\"loginPrompt\" class=\"login-prompt\" style=\"display: none;\">\n        <i class=\"bi bi-lock\"></i>\n        <h2>로그인이 필요합니다</h2>\n        <p class=\"text-muted mb-3\">리뷰 관리 기능을 사용하려면 먼저 로그인해주세요.</p>\n        <a href=\"/login\" class=\"btn btn-primary\">로그인하기</a>\n    </div>\n    \n    <!-- 메인 컨텐츠 (로그인 후 표시) -->\n    <div id=\"mainContent\" style=\"display: none;\">\n        <!-- 페이지 헤더 -->\n        <div class=\"mb-4\">\n            <h1 class=\"mb-2\">리뷰 관리</h1>\n            <p class=\"text-muted\">고객 리뷰를 확인하고 답글을 작성하세요</p>\n        </div>\n        \n        <!-- 통계 대시보드 -->\n        <div id=\"statsSection\" class=\"row mb-4\" style=\"display: none;\">\n            <div class=\"col-md-3\">\n                <div class=\"stats-card\">\n                    <h3 id=\"totalReviews\">0</h3>\n                    <p>전체 리뷰</p>\n                </div>\n            </div>\n            <div class=\"col-md-3\">\n                <div class=\"stats-card\" style=\"background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);\">\n                    <h3 id=\"avgRating\">0.0</h3>\n                    <p>평균 별점</p>\n                </div>\n            </div>\n            <div class=\"col-md-3\">\n                <div class=\"stats-card\" style=\"background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);\">\n                    <h3 id=\"replyRate\">0%</h3>\n                    <p>답변율</p>\n                </div>\n            </div>\n            <div class=\"col-md-3\">\n                <div class=\"stats-card\" style=\"background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);\">\n                    <h3 id=\"pendingReviews\">0</h3>\n                    <p>미답변 리뷰</p>\n                </div>\n            </div>\n        </div>\n        \n        <!-- 필터 섹션 -->\n        <div class=\"filter-section\">\n            <div class=\"row\">\n                <div class=\"col-md-4\">\n                    <div class=\"form-group\">\n                        <label class=\"form-label\">매장 선택</label>\n                        <select id=\"storeSelect\" class=\"form-control\">\n                            <option value=\"\">매장을 선택하세요</option>\n                        </select>\n                    </div>\n                </div>\n                <div class=\"col-md-3\">\n                    <div class=\"form-group\">\n                        <label class=\"form-label\">답변 상태</label>\n                        <select id=\"statusFilter\" class=\"form-control\">\n                            <option value=\"\">전체</option>\n                            <option value=\"pending\">미답변</option>\n                            <option value=\"posted\">답변완료</option>\n                            <option value=\"failed\">실패</option>\n                        </select>\n                    </div>\n                </div>\n                <div class=\"col-md-3\">\n                    <div class=\"form-group\">\n                        <label class=\"form-label\">별점</label>\n                        <select id=\"ratingFilter\" class=\"form-control\">\n                            <option value=\"\">전체</option>\n                            <option value=\"5\">⭐⭐⭐⭐⭐ (5점)</option>\n                            <option value=\"4\">⭐⭐⭐⭐ (4점)</option>\n                            <option value=\"3\">⭐⭐⭐ (3점)</option>\n                            <option value=\"2\">⭐⭐ (2점)</option>\n                            <option value=\"1\">⭐ (1점)</option>\n                        </select>\n                    </div>\n                </div>\n                <div class=\"col-md-2\">\n                    <div class=\"form-group\">\n                        <label class=\"form-label\">&nbsp;</label>\n                        <button id=\"refreshBtn\" class=\"btn btn-primary btn-block\">\n                            <i class=\"bi bi-arrow-clockwise\"></i> 새로고침\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n        \n        <!-- 리뷰 목록 -->\n        <div id=\"reviewsList\">\n            <div class=\"text-center text-muted py-5\">\n                <i class=\"bi bi-chat-square-text\" style=\"font-size: 3rem;\"></i>\n                <p class=\"mt-2\">매장을 선택하여 리뷰를 확인하세요</p>\n            </div>\n        </div>\n        \n        <!-- 페이지네이션 -->\n        <nav id=\"pagination\" style=\"display: none;\">\n            <ul class=\"pagination justify-content-center\">\n                <!-- 페이지네이션 버튼들이 여기에 동적으로 추가됩니다 -->\n            </ul>\n        </nav>\n    </div>\n</div>\n\n<!-- 답글 작성 모달 -->\n<div id=\"replyModal\" class=\"modal\">\n    <div class=\"modal-content\">\n        <span class=\"modal-close\" onclick=\"closeReplyModal()\">&times;</span>\n        <h2 class=\"mb-3\">답글 작성</h2>\n        \n        <div id=\"reviewInfo\" class=\"mb-3\">\n            <!-- 리뷰 정보가 여기에 표시됩니다 -->\n        </div>\n        \n        <form id=\"replyForm\">\n            <input type=\"hidden\" id=\"replyReviewId\">\n            \n            <div class=\"form-group\">\n                <label class=\"form-label\">답글 유형</label>\n                <select id=\"replyType\" class=\"form-control\">\n                    <option value=\"full_manual\">직접 작성</option>\n                    <option value=\"ai_manual\">AI 제안 수정</option>\n                    <option value=\"ai_auto\">AI 자동 작성</option>\n                </select>\n            </div>\n            \n            <div class=\"form-group\">\n                <label class=\"form-label\">답글 내용</label>\n                <textarea id=\"replyContent\" class=\"form-control\" rows=\"5\" placeholder=\"답글을 입력하세요...\" required></textarea>\n                <small class=\"text-muted\">\n                    <span id=\"charCount\">0</span> / 1000자\n                </small>\n            </div>\n            \n            <div class=\"text-right\">\n                <button type=\"button\" class=\"btn btn-secondary\" onclick=\"closeReplyModal()\">취소</button>\n                <button type=\"submit\" class=\"btn btn-primary\">\n                    <i class=\"bi bi-send\"></i> 답글 등록\n                </button>\n            </div>\n        </form>\n    </div>\n</div>\n{% endblock %}\n\n{% block extra_js %}\n<!-- API 설정 먼저 로드 -->\n<script src=\"{{ url_for('static', path='/js/api-config.js') }}\"></script>\n<script>\n// 전역 변수\nlet currentStoreCode = '';\nlet currentPage = 0;\nconst pageSize = 20;\n\n// 페이지 로드시 초기화\ndocument.addEventListener('DOMContentLoaded', function() {\n    checkAuthAndInit();\n});\n\n// 인증 체크 및 초기화\nasync function checkAuthAndInit() {\n    const token = getToken();\n    \n    if (!token) {\n        // 토큰이 없으면 로그인 안내 표시\n        document.getElementById('loginPrompt').style.display = 'block';\n        document.getElementById('mainContent').style.display = 'none';\n        return;\n    }\n    \n    // 토큰이 있으면 메인 컨텐츠 표시\n    document.getElementById('loginPrompt').style.display = 'none';\n    document.getElementById('mainContent').style.display = 'block';\n    \n    // 초기화\n    try {\n        await loadStores();\n        setupEventListeners();\n    } catch (error) {\n        console.error('초기화 실패:', error);\n        if (error.message && error.message.includes('401')) {\n            // 토큰이 만료된 경우\n            showAlert('세션이 만료되었습니다. 다시 로그인해주세요.', 'warning');\n            setTimeout(() => {\n                window.location.href = '/login';\n            }, 2000);\n        }\n    }\n}\n\n// 이벤트 리스너 설정\nfunction setupEventListeners() {\n    document.getElementById('storeSelect').addEventListener('change', onStoreChange);\n    document.getElementById('statusFilter').addEventListener('change', loadReviews);\n    document.getElementById('ratingFilter').addEventListener('change', loadReviews);\n    document.getElementById('refreshBtn').addEventListener('click', refreshData);\n    document.getElementById('replyForm').addEventListener('submit', submitReply);\n    document.getElementById('replyContent').addEventListener('input', updateCharCount);\n}\n\n// 매장 목록 로드 - API 경로 수정됨\nasync function loadStores() {\n    try {\n        const stores = await apiRequest('/stores');\n        const select = document.getElementById('storeSelect');\n        \n        // 기존 옵션 제거 (첫 번째 옵션 제외)\n        while (select.options.length > 1) {\n            select.remove(1);\n        }\n        \n        // API 응답이 배열인지 객체인지 확인\n        const storeList = Array.isArray(stores) ? stores : (stores.stores || []);\n        \n        storeList.forEach(store => {\n            const option = document.createElement('option');\n            option.value = store.store_code;\n            option.textContent = `${store.store_name} (${store.platform})`;\n            select.appendChild(option);\n        });\n        \n        if (storeList.length === 0) {\n            showAlert('등록된 매장이 없습니다. 먼저 매장을 등록해주세요.', 'info');\n        }\n    } catch (error) {\n        showAlert('매장 목록을 불러오는데 실패했습니다: ' + error.message, 'danger');\n    }\n}\n\n// 매장 변경시\nasync function onStoreChange() {\n    currentStoreCode = document.getElementById('storeSelect').value;\n    currentPage = 0;\n    \n    if (currentStoreCode) {\n        document.getElementById('statsSection').style.display = 'flex';\n        await Promise.all([loadStats(), loadReviews()]);\n    } else {\n        document.getElementById('statsSection').style.display = 'none';\n        document.getElementById('reviewsList').innerHTML = `\n            <div class=\"text-center text-muted py-5\">\n                <i class=\"bi bi-chat-square-text\" style=\"font-size: 3rem;\"></i>\n                <p class=\"mt-2\">매장을 선택하여 리뷰를 확인하세요</p>\n            </div>\n        `;\n        document.getElementById('pagination').style.display = 'none';\n    }\n}\n\n// 통계 로드 - API 경로 수정됨\nasync function loadStats() {\n    try {\n        const stats = await apiRequest(`/reviews/stats/${currentStoreCode}`);\n        \n        document.getElementById('totalReviews').textContent = stats.total_reviews || 0;\n        document.getElementById('avgRating').textContent = (stats.avg_rating || 0).toFixed(1);\n        document.getElementById('replyRate').textContent = (stats.reply_rate || 0) + '%';\n        document.getElementById('pendingReviews').textContent = stats.pending_reviews || 0;\n    } catch (error) {\n        console.error('통계 로드 실패:', error);\n        // 통계 로드 실패해도 리뷰 목록은 표시\n    }\n}\n\n// 리뷰 목록 로드 - API 경로 수정됨\nasync function loadReviews() {\n    if (!currentStoreCode) return;\n    \n    const status = document.getElementById('statusFilter').value;\n    const rating = document.getElementById('ratingFilter').value;\n    \n    // 로딩 표시\n    document.getElementById('reviewsList').innerHTML = '<div class=\"text-center py-5\"><div class=\"spinner\"></div></div>';\n    \n    try {\n        const params = new URLSearchParams({\n            limit: pageSize,\n            offset: currentPage * pageSize\n        });\n        \n        if (status) params.append('status', status);\n        if (rating) params.append('rating', rating);\n        \n        const reviews = await apiRequest(`/reviews/${currentStoreCode}?${params}`);\n        \n        renderReviews(reviews);\n        updatePagination(reviews.length);\n        \n    } catch (error) {\n        document.getElementById('reviewsList').innerHTML = `\n            <div class=\"text-center text-muted py-5\">\n                <i class=\"bi bi-exclamation-triangle\" style=\"font-size: 3rem; color: var(--danger-color);\"></i>\n                <p class=\"mt-2\">리뷰를 불러오는데 실패했습니다</p>\n                <p class=\"small\">${error.message}</p>\n                <button class=\"btn btn-primary btn-sm mt-2\" onclick=\"loadReviews()\">다시 시도</button>\n            </div>\n        `;\n    }\n}\n\n// 나머지 함수들은 동일하므로 생략...\n</script>\n{% endblock %}"